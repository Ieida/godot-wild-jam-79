[gd_scene load_steps=29 format=3 uid="uid://00o16vqo5xxv"]

[ext_resource type="PackedScene" uid="uid://dr3av80rwwqwb" path="res://elements/plant/plant.tscn" id="1_joivf"]
[ext_resource type="Shader" uid="uid://bsij6f2n1k3mn" path="res://shaders/sprite_shader.gdshader" id="2_16su2"]
[ext_resource type="Texture2D" uid="uid://cy2ym7ngwwdbv" path="res://assets/mushroom.png" id="2_vr1oj"]

[sub_resource type="RectangleShape2D" id="RectangleShape2D_joivf"]

[sub_resource type="CircleShape2D" id="CircleShape2D_vr1oj"]
radius = 92.0

[sub_resource type="ShaderMaterial" id="ShaderMaterial_130wy"]
resource_local_to_scene = true
shader = ExtResource("2_16su2")
shader_parameter/flash = false
shader_parameter/flash_color = Color(1, 1, 1, 1)

[sub_resource type="AtlasTexture" id="AtlasTexture_16su2"]
atlas = ExtResource("2_vr1oj")
region = Rect2(0, 0, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_vr1oj"]
atlas = ExtResource("2_vr1oj")
region = Rect2(0, 32, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_130wy"]
atlas = ExtResource("2_vr1oj")
region = Rect2(0, 64, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_joivf"]
atlas = ExtResource("2_vr1oj")
region = Rect2(0, 96, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_nvxg1"]
atlas = ExtResource("2_vr1oj")
region = Rect2(192, 0, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_7c5xo"]
atlas = ExtResource("2_vr1oj")
region = Rect2(192, 32, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_y7pgb"]
atlas = ExtResource("2_vr1oj")
region = Rect2(192, 64, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_rxt22"]
atlas = ExtResource("2_vr1oj")
region = Rect2(192, 96, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_md32m"]
atlas = ExtResource("2_vr1oj")
region = Rect2(192, 128, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_p5y2q"]
atlas = ExtResource("2_vr1oj")
region = Rect2(192, 160, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_7ttph"]
atlas = ExtResource("2_vr1oj")
region = Rect2(192, 192, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_fi1px"]
atlas = ExtResource("2_vr1oj")
region = Rect2(192, 224, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_urfy4"]
atlas = ExtResource("2_vr1oj")
region = Rect2(192, 256, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_42egm"]
atlas = ExtResource("2_vr1oj")
region = Rect2(192, 288, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_xa7qm"]
atlas = ExtResource("2_vr1oj")
region = Rect2(96, 0, 96, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_lc416"]
atlas = ExtResource("2_vr1oj")
region = Rect2(96, 32, 96, 32)

[sub_resource type="SpriteFrames" id="SpriteFrames_130wy"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_16su2")
}],
"loop": true,
"name": &"age_1",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_vr1oj")
}],
"loop": true,
"name": &"age_2",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_130wy")
}],
"loop": true,
"name": &"age_3",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_joivf")
}],
"loop": true,
"name": &"age_4",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_nvxg1")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_7c5xo")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_y7pgb")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_rxt22")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_md32m")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_p5y2q")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_7ttph")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_fi1px")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_urfy4")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_42egm")
}],
"loop": false,
"name": &"attack",
"speed": 8.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_xa7qm")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_lc416")
}],
"loop": true,
"name": &"idle",
"speed": 1.0
}]

[sub_resource type="GDScript" id="GDScript_16su2"]
resource_name = "grow"
script/source = "extends State


@onready var plant: Plant = $\"../..\"


func _physics_process(_delta: float) -> void:
	if not active and should_enter():
		machine.activate_state(name)
	
	if active:
		var age = minf(plant.max_age - 1.0, plant.age)
		# Play animation based on age
		var anim_name = &\"age_%s\" % (floori(age) + 1)
		plant.sprite.play(anim_name)
		if plant.age >= plant.max_age - 1.0: machine.deactivate_state()


func should_enter() -> bool:
	if machine.active_state != NULL_STATE: return false
	if plant.age >= plant.max_age: return false
	return true
"

[sub_resource type="GDScript" id="GDScript_joivf"]
resource_name = "idle"
script/source = "extends State


@onready var plant: Plant = $\"../..\"


func _physics_process(_delta: float) -> void:
	if not active and should_enter():
		machine.activate_state(name)


func enter():
	plant.sprite.play(&\"idle\")


func should_enter() -> bool:
	if machine.active_state == NULL_STATE: return true
	return false
"

[sub_resource type="GDScript" id="GDScript_vr1oj"]
resource_name = "attack"
script/source = "extends State


@export var interval: float = 0.2
@onready var plant: Plant = $\"../..\"
@onready var vision_area: Area2D = $\"../../VisionArea\"
var enemies: Array[Enemy]
var time_elapsed: float


func _deal_damage():
	for e in enemies:
		e.hitbox.take_hit(plant.damage)


func _on_anim_finished():
	if active and plant.sprite.animation == &\"attack\":
		machine.deactivate_state()


func _on_vision_body_entered(body: Node2D):
	if body is Enemy:
		enemies.append(body)


func _on_vision_body_exited(body: Node2D):
	if body is Enemy and enemies.has(body):
		enemies.erase(body)


func _physics_process(delta: float) -> void:
	var t := INF if active else plant.attack_cooldown
	time_elapsed = minf(t, time_elapsed + delta)
	
	if active:
		if is_zero_approx(fmod(time_elapsed, interval)):
			_deal_damage()
	
	if should_enter(): machine.activate_state(name)


func _ready() -> void:
	vision_area.body_entered.connect(_on_vision_body_entered)
	vision_area.body_exited.connect(_on_vision_body_exited)
	await plant.ready
	plant.sprite.animation_finished.connect(_on_anim_finished)


func enter():
	plant.sprite.play(&\"attack\")
	time_elapsed = 0
	var e = get_closest_enemy()
	if e:
		var de = plant.global_position.direction_to(e.global_position)
		var d = Vector2.RIGHT.dot(de)
		var f = d < 0.0
		plant.sprite.flip_h = f
		plant.sprite.offset.x = -absf(plant.sprite.offset.x) if f else absf(plant.sprite.offset.x)


func exit():
	time_elapsed = 0


func get_closest_enemy() -> Enemy:
	if enemies.size() == 0: return null
	
	var plant_pos: Vector2 = plant.global_position
	var ce: Enemy = null
	var cd: float = INF
	for e in enemies:
		var d := plant_pos.distance_to(e.global_position)
		if d < cd:
			ce = e
			cd = d
	return ce


func should_enter() -> bool:
	if active: return false
	if time_elapsed < plant.attack_cooldown: return false
	if plant.age < plant.max_age: return false
	if enemies.size() == 0: return false
	if machine.active_state == &\"withered\": return false
	return true
"

[sub_resource type="GDScript" id="GDScript_130wy"]
resource_name = "hit"
script/source = "extends State


@export var duration: float = 0.1
@onready var plant: Plant = $\"../..\"
var material: ShaderMaterial
var time_elapsed: float


func _on_hitbox_hit():
	machine.activate_state(name)


func _physics_process(delta: float) -> void:
	if active:
		time_elapsed += delta
		if time_elapsed >= duration:
			machine.deactivate_state()


func _ready() -> void:
	await plant.ready
	plant.hitbox.hit.connect(_on_hitbox_hit)
	material = plant.sprite.material


func enter():
	time_elapsed = 0
	plant.sprite.stop()
	if material:
		material.set_shader_parameter(&\"flash\", true)


func exit():
	if material:
		material.set_shader_parameter(&\"flash\", false)
"

[sub_resource type="GDScript" id="GDScript_xa7qm"]
resource_name = "withered"
script/source = "extends State


@onready var plant: Plant = $\"../..\"


func _on_hitbox_depleted():
	machine.activate_state(name)


func _ready() -> void:
	await plant.ready
	plant.hitbox.depleted.connect(_on_hitbox_depleted)


func enter():
	plant.collider.process_mode = Node.PROCESS_MODE_DISABLED
	plant.sprite.stop()
	var clr = Color.WHITE
	clr.a = 0.5
	plant.sprite.modulate = clr
"

[node name="Mushroom" instance=ExtResource("1_joivf")]
target_position = Vector2(0, 0)
age_speed = 2.0
attack_cooldown = 3.0
max_age = 4.0

[node name="CollisionShape2D" parent="Collider" index="0"]
shape = SubResource("RectangleShape2D_joivf")

[node name="Hitbox" parent="." index="1"]
max_health = 100.0

[node name="CollisionShape2D" parent="Hitbox" index="0"]
shape = SubResource("RectangleShape2D_joivf")

[node name="CollisionShape2D" parent="VisionArea" index="0"]
shape = SubResource("CircleShape2D_vr1oj")

[node name="AnimatedSprite2D" parent="." index="3"]
material = SubResource("ShaderMaterial_130wy")
sprite_frames = SubResource("SpriteFrames_130wy")
animation = &"attack"
autoplay = "age_1"
frame = 9
frame_progress = 1.0
offset = Vector2(32, -5)

[node name="grow" type="Node" parent="StateMachine" index="0"]
script = SubResource("GDScript_16su2")

[node name="idle" type="Node" parent="StateMachine" index="1"]
script = SubResource("GDScript_joivf")

[node name="attack" type="Node" parent="StateMachine" index="2"]
script = SubResource("GDScript_vr1oj")

[node name="hit" type="Node" parent="StateMachine" index="3"]
script = SubResource("GDScript_130wy")

[node name="withered" type="Node" parent="StateMachine" index="4"]
script = SubResource("GDScript_xa7qm")
